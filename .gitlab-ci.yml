stages:
  - docker

.builder: &builder
  image: docker:17.12
  services:
    - docker:17.12-dind
  stage: docker
  variables:
    RELEASE: "master"
  script:
    - cd $CI_JOB_NAME
    - docker build --build-arg RELEASE=$RELEASE -t bennu/$CI_JOB_NAME:$RELEASE .
    - if [ $RELEASE != "master" ]; then docker tag bennu/$CI_JOB_NAME:$RELEASE bennu/$CI_JOB_NAME:latest; fi
    - echo $HUB_PASS | docker login -u $HUB_USER --password-stdin
    - docker push bennu/$CI_JOB_NAME
    - docker logout

govc:
  <<: *builder
  variables:
    RELEASE: "v0.18.0"
